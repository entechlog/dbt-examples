<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>fact_sales Data Model</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        #container { background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .mermaid { overflow: auto; }
        .buttons { margin-top: 20px; text-align: center; }
        button { padding: 8px 16px; margin: 0 5px; background-color: #4b6bbd; color: white; 
                 border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #3a559d; }
        .footer { margin-top: 20px; text-align: center; color: #666; font-size: 0.9em; }
        #codeArea { display: none; }
    </style>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { htmlLabels: true },
            er: {
                diagramPadding: 20,
                layoutDirection: 'LR',
                minEntityWidth: 120,
                minEntityHeight: 75,
                entityPadding: 15
            }
        });
    </script>
</head>
<body>
    <div id="container">
        <h1>fact_sales Data Model</h1>
        <div class="mermaid">
erDiagram
    fact_sales {
        int sales_id PK
        int order_item_key
        int order_key FK
        int product_id FK
        date sale_date_id FK
        int quantity_sold
        float unit_price
        int gross_sales
        float discount_amount
        int net_sales
        float total_cost
        string profit
        float profit_margin_percentage
    }

    dim_product {
        int product_id PK
        string product_key
        string product_name
        float unit_price
        float unit_cost
        string unit_margin
        float margin_percentage
    }

    dim_product |o--o{ fact_sales : "product_id"
    dim_customer {
        int customer_id PK
        string customer_key
        string email
        string full_name
        string customer_segment
    }

    dim_customer ||--|| fact_sales : "sales_id"
    dim_date {
        date date_id PK
        date date_actual
        string day_name
        string month_name
        string quarter
        string year
        boolean is_weekend
        int fiscal_year
        string fiscal_quarter
    }

    dim_date ||--o{ fact_sales : "sale_date_id"

        </div>
        
        <div class="buttons">
            <button onclick="saveSvg()">Download as SVG</button>
            <button onclick="savePng()">Download as PNG</button>
            <button onclick="copyMermaidCode()">Copy Mermaid Code</button>
        </div>
        
        <div class="footer">
            <p>Generated by dbt-erd v1.0.0</p>
        </div>
    </div>
    
    <!-- Hidden textarea for copying -->
    <textarea id="codeArea">erDiagram
    fact_sales {
        int sales_id PK
        int order_item_key
        int order_key FK
        int product_id FK
        date sale_date_id FK
        int quantity_sold
        float unit_price
        int gross_sales
        float discount_amount
        int net_sales
        float total_cost
        string profit
        float profit_margin_percentage
    }

    dim_product {
        int product_id PK
        string product_key
        string product_name
        float unit_price
        float unit_cost
        string unit_margin
        float margin_percentage
    }

    dim_product |o--o{ fact_sales : "product_id"
    dim_customer {
        int customer_id PK
        string customer_key
        string email
        string full_name
        string customer_segment
    }

    dim_customer ||--|| fact_sales : "sales_id"
    dim_date {
        date date_id PK
        date date_actual
        string day_name
        string month_name
        string quarter
        string year
        boolean is_weekend
        int fiscal_year
        string fiscal_quarter
    }

    dim_date ||--o{ fact_sales : "sale_date_id"
</textarea>
    
    <script>
        function copyMermaidCode() {
            const codeArea = document.getElementById('codeArea');
            codeArea.style.display = 'block';
            codeArea.select();
            document.execCommand('copy');
            codeArea.style.display = 'none';
            alert('Mermaid code copied to clipboard!');
        }
    
        function saveSvg() {
            // Get the SVG element
            setTimeout(() => {
                const svgElement = document.querySelector('.mermaid svg');
                if (!svgElement) {
                    alert('SVG not found. Please wait for diagram to render.');
                    return;
                }
                
                // Get SVG source
                const serializer = new XMLSerializer();
                let source = serializer.serializeToString(svgElement);
                
                // Add namespaces
                if (!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                
                // Convert SVG source to URI data scheme
                const svgBlob = new Blob([source], {type:"image/svg+xml;charset=utf-8"});
                const svgUrl = URL.createObjectURL(svgBlob);
                
                // Create download link
                const downloadLink = document.createElement("a");
                downloadLink.href = svgUrl;
                downloadLink.download = "fact_sales_diagram.svg";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }, 1000); // Wait for diagram to render
        }
        
        function savePng() {
            // Get the SVG element
            setTimeout(() => {
                const svgElement = document.querySelector('.mermaid svg');
                if (!svgElement) {
                    alert('SVG not found. Please wait for diagram to render.');
                    return;
                }
                
                // Create a canvas element
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Get SVG dimensions
                const svgRect = svgElement.getBoundingClientRect();
                canvas.width = svgRect.width;
                canvas.height = svgRect.height;
                
                // Create image from SVG
                const img = new Image();
                const serializer = new XMLSerializer();
                const svgStr = serializer.serializeToString(svgElement);
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgStr)));
                
                img.onload = function() {
                    // Draw image to canvas
                    ctx.drawImage(img, 0, 0);
                    
                    // Convert to PNG
                    try {
                        const pngUrl = canvas.toDataURL('image/png');
                        
                        // Create download link
                        const downloadLink = document.createElement('a');
                        downloadLink.href = pngUrl;
                        downloadLink.download = 'fact_sales_diagram.png';
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                    } catch(e) {
                        console.error(e);
                        alert('Error creating PNG. This might be due to CORS restrictions if opening the file directly.');
                    }
                };
            }, 1000); // Wait for diagram to render
        }
    </script>
</body>
</html>
